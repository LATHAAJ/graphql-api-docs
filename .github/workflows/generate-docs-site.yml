name: Generate Documentation Site

on:
  repository_dispatch:
    types: [update-docs]
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  generate-docs-site:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout docs repo
        uses: actions/checkout@v4

      - name: Check if MAIN_REPO_TOKEN exists
        run: |
          if [ -z "${{ secrets.MAIN_REPO_TOKEN }}" ]; then
            echo "âŒ MAIN_REPO_TOKEN secret is not set!"
            echo "Please add MAIN_REPO_TOKEN secret to this repository"
            exit 1
          else
            echo "âœ… MAIN_REPO_TOKEN secret is configured"
          fi

      - name: Checkout main GraphQL repo
        uses: actions/checkout@v4
        with:
          repository: LATHAAJ/GraphQl-players
          path: main-repo
          token: ${{ secrets.MAIN_REPO_TOKEN }}
          ref: documentGeneration

      - name: Debug - List files in main-repo
        run: |
          echo "Contents of main-repo directory:"
          ls -la main-repo/
          echo "Contents of main-repo/src directory:"
          ls -la main-repo/src/ || echo "src directory not found"
          echo "Contents of main-repo/src/main directory:"
          ls -la main-repo/src/main/ || echo "src/main directory not found"
          echo "Contents of main-repo/src/main/resources directory:"
          ls -la main-repo/src/main/resources/ || echo "src/main/resources directory not found"
          echo "Contents of main-repo/src/main/resources/graphql directory:"
          ls -la main-repo/src/main/resources/graphql/ || echo "src/main/resources/graphql directory not found"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          npm install graphql-markdown

      - name: Generate documentation
        run: |
          npx graphql-markdown ./main-repo/src/main/resources/graphql/schema.graphql --title "GraphQL API Documentation" > schema-documentation.md

      - name: Update documentation in docs repo
        run: |
          # Update the main documentation file
          cp schema-documentation.md docs/graphql/schema-documentation.md
          
          # Create a simple index page
          cat > index.md << 'EOF'
          # GraphQL API Documentation
          
          Welcome to the GraphQL API Documentation!
          
          ## Quick Links
          - [Schema Documentation](./docs/graphql/schema-documentation.md)
          - [API Reference](./docs/graphql/schema-documentation.md)
          
          ## About
          This documentation is automatically generated from the GraphQL schema.
          EOF
          
          # Commit and push changes
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git diff --staged --quiet || git commit -m "Update GraphQL documentation from schema changes [skip ci]"
          git push https://${{ secrets.MAIN_REPO_TOKEN }}@github.com/LATHAAJ/graphql-api-docs.git

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./
          publish_branch: gh-pages

