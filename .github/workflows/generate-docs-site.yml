name: Generate Documentation Site

on:
  repository_dispatch:
    types: [update-docs]
  workflow_dispatch:
  push:
    branches: [main, documentGeneration]

jobs:
  generate-docs-site:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout docs repo
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Check if MAIN_REPO_TOKEN exists
        run: |
          if [ -z "${{ secrets.MAIN_REPO_TOKEN }}" ]; then
            echo "‚ùå MAIN_REPO_TOKEN secret is not set!"
            echo "Please add MAIN_REPO_TOKEN secret to this repository"
            exit 1
          else
            echo "‚úÖ MAIN_REPO_TOKEN secret is configured"
          fi

      - name: Download schema file
        run: |
          echo "üîÑ Downloading schema from documentGeneration branch..."
          curl -H "Authorization: token ${{ secrets.MAIN_REPO_TOKEN }}" \
               -H "Accept: application/vnd.github.v3.raw" \
               -o schema.graphql \
               "https://api.github.com/repos/LATHAAJ/GraphQl-players/contents/src/main/resources/graphql/schema.graphql?ref=documentGeneration" || \
          curl -H "Authorization: token ${{ secrets.MAIN_REPO_TOKEN }}" \
               -H "Accept: application/vnd.github.v3.raw" \
               -o schema.graphql \
               "https://api.github.com/repos/LATHAAJ/GraphQl-players/contents/src/main/resources/graphql/schema.graphql?ref=main"
          
          echo "‚úÖ Schema downloaded. Checking for new fields..."
          grep -n "jerseyNumber\|nickname" schema.graphql || echo "‚ùå New fields not found in schema"
          echo "üìã First 20 lines of schema:"
          head -20 schema.graphql

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          npm install graphql-markdown

      - name: Generate documentation
        run: |
          echo "üîÑ Generating documentation..."
          npx graphql-markdown ./schema.graphql --title "GraphQL API Documentation" > schema-documentation.md
          echo "‚úÖ Documentation generated. Checking for new fields in docs..."
          grep -n "jerseyNumber\|nickname" schema-documentation.md || echo "‚ùå New fields not found in generated docs"

      - name: Update documentation files
        run: |
          cp schema-documentation.md docs/graphql/schema-documentation.md

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.MAIN_REPO_TOKEN }}
          publish_dir: ./
          publish_branch: gh-pages